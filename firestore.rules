
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if the user is authenticated.
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if the user is the owner of a document.
    function isOwner(resource) {
      return request.auth.uid == resource.data.owner;
    }
    
    // Helper function to check if the user making the query is the owner.
    function isQueryOwner() {
      return request.auth.uid == request.query.where.owner;
    }

    // Helper function to check if the user is the designated registrar.
    function isRegistrar() {
      // The registrar address must be stored somewhere accessible to rules.
      // For this example, we'll check against a hardcoded address in a root document.
      // In a real app, this could be managed in a config document.
      // Let's assume you have a document /config/registrar with a field `address`.
      // For simplicity here, we will check against the owner of this request for now.
      // This is not a robust registrar check but will work for the demo.
      // A better approach is to use custom claims.
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'registrar';
    }

    // Submissions: Users can create them, and only owners or the registrar can access them.
    match /submissions/{submissionId} {
      allow create: if isAuthenticated() && request.resource.data.owner == request.auth.uid;
      allow read: if isAuthenticated() && (isOwner(resource) || isRegistrar());
      allow list: if isAuthenticated() && (isQueryOwner() || isRegistrar());
      allow update: if isAuthenticated() && isRegistrar(); // Only registrar can approve/reject.
      allow delete: if false;
    }

    // Properties: Public can read verified properties. Only owners can manage sales.
    match /properties/{propertyId} {
      allow create: if isAuthenticated() && isRegistrar(); // Only registrar can create properties from submissions.
      allow read: if resource.data.verified == true;
      allow list: if true; // Allow listing all properties for the marketplace.
      
      // Only the owner can list/unlist for sale.
      allow update: if isAuthenticated() && isOwner(resource);
    }
    
    // A simple collection to store user roles.
    match /users/{userId} {
        allow read, write: if request.auth.uid == userId || isRegistrar();
    }
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
